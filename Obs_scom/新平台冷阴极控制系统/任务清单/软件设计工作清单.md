---
time: 2025-03-14
tags:
  - C
  - scom
---
# 一、系统功能

| 编号  | 功能模块名称               | 功能描述                                                                                                                                                                                                                                                                                                              | 性能指标                                                                                                          |
| --- | -------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| 1   | X射线控制模块 (xray485)    | 1. 通过 Modbus RTU 协议与 X 射线管通信<br>2. 控制 X 射线管的电压、电流和曝光时间<br>3. 支持的最大参数：最大电压 200.0V，最大电流 2000.0mA                                                                                                                                                                                                                    | 一条RS485命令执行时间不大于50ms                                                                                          |
| 2   | 液晶模块 (lcd)           | 1. 显示系统参数：<br>    a. 曝光电压<br>    b. 曝光时间<br>    c. 曝光倒计时<br>    d. 曝光紧急停止状态<br>2. 显示系统状态：<br>    a. WiFi 连接状态<br>    b. 网络连接状态<br>    c. 电池电量<br>3. 倒计时功能：<br>    a. 显示曝光倒计时总时间<br>    b. 曝光结束后清零倒计时时间<br>    c. 在延迟曝光过程中，如果接收到曝光停止消息将倒计时时间清零<br>4. 紧急停止显示：<br>    a. 收到曝光紧急停止消息后显示为 “yes”<br>    b. 曝光结束后显示为“no” | a. 收到曝光紧急停止消息后显示为 “yes”<br>    b. 曝光结束后1秒显示为“no”                                                              |
| 3   | 网络通信模块 (sc_eth)      | 1. 实现 TCP 服务器功能<br>2. 接受客户端连接<br>3. 处理网络数据收发                                                                                                                                                                                                                                                                      | N/A                                                                                                           |
| 4   | 电池管理模块 (check_power) | 1. 实时监测低电量状态<br>    a. 低电量阈值：20%<br>    b. 触发 LED 绿灯闪烁<br>2. 电量变化时将电量百分比发送给 LCD<br>3. 每 4 分钟发给数据库记录一次电池电量                                                                                                                                                                                                         | N/A                                                                                                           |
| 5   | CPU 温度检测模块           | 1. 每 3 分钟将 CPU 温度发送给数据库                                                                                                                                                                                                                                                                                           | N/A                                                                                                           |
| 6   | 延迟曝光key和延迟曝光_cmd模块   | 1. 延迟曝光消息处理进程<br>2. 延迟曝光按键处理进程<br>3. 延迟曝光过程中：<br>    a. 发消息给 beep（500ms 蜂鸣一次）<br>    b. lcd（显示曝光倒计时时间）<br>    c. LED 红灯（闪烁）<br>4. 延迟结束：<br>    a. 发送消息给射线管开始曝光<br>    b. 发消息给 beep 蜂鸣 2s<br>    c. 发消息给 lcd（清除曝光倒计时时间）<br>    d. 发消息给红色 LED（亮 2 秒）                                                                | 1. 延迟曝光过程中：<br>    a. 发消息给 beep（500ms 蜂鸣一次）<br>2. 延迟结束：<br>    a. 发消息给 beep 蜂鸣 2s<br>    b. 发消息给红色 LED（亮 2 秒） |
| 7   | LED 灯模块              | 1. 红灯：<br>    a. 延迟曝光时闪烁<br>    b. 曝光时亮 2 秒<br>2. 绿灯：<br>    a. 电量过低时绿灯亮                                                                                                                                                                                                                                          | N/A                                                                                                           |
| 8   | 网络串口通信模块 (sc_232)    | 1. 处理串口数据收发                                                                                                                                                                                                                                                                                                       | N/A                                                                                                           |
| 9   | beep 模块 (sc_beep)    | 1. 延迟曝光过程中 500ms 蜂鸣一次<br>2. 曝光时蜂鸣 2 秒                                                                                                                                                                                                                                                                             | N/A                                                                                                           |
| 10  | 选择按键模块 (sc_select)   | 1. 按键一次配置电压 200kV、电流 2000mA<br>2. 再按键一次配置电压 100kV、电流 1000mA                                                                                                                                                                                                                                                       | N/A                                                                                                           |
| 11  | 紧急中断key和紧急中断cmd模块    | 1. 紧急停止消息处理进程<br>2. 紧急停止按键处理进程<br>3. 紧急停止过程：<br>    a. 中止并重启延迟，beep 和 led<br>    b. 发消息给射线管中止曝光<br>    c. 发消息给 lcd 紧急停止显示为“yes”                                                                                                                                                                                   | N/A                                                                                                           |
| 12  | 历史记录模块 (sc_record)   | 1. 记录 CPU 的温度数据<br>2. 记录电池电量数据<br>3. 记录配置射线机参数<br>4. 使用 query 获取射线机配置参数<br>5. 记录曝光前后的参数<br>6. 上电恢复射线机配置参数                                                                                                                                                                                                         | N/A                                                                                                           |
| 13  | json数据处理             | 1. 处理 JSON 格式的数据包<br>2. 处理操作命令：<br>    a. cfg--配置射线机参数<br>    b. query--获取射线机参数<br>    c.  explosive--立即曝光和延迟曝光<br>    d. stop--紧急停止<br>    e. version--查看版本<br>    f. time--更新时间<br>	g. power--查看电池电量                                                                                                            | N/A                                                                                                           |


# 二、软件设计细目
## 1 系统设计

| 编号  | 任务     | 任务描述               | 备注  |
| --- | ------ | ------------------ | --- |
| 1   | 划分系统主题 | 展示MQTT主题和系统的业务逻辑关系 |     |

## 2 git环境

| 编号  | 任务            | 任务描述                               | 备注  |
| --- | ------------- | ---------------------------------- | --- |
| 1   | 调研git服务器部署环境  | n/a                                |     |
| 2   | 部署极狐gitlab    | 在现有服务器上部署极狐gitlab                  |     |
| 3   | 天嵌SDK repo 基础 | 需要提交2笔                             |     |
| 4   | 分支管理          | 创建release、develop、feature-kernel分支 |     |
|     |               |                                    |     |

## 3 驱动层开发

| 编号  | 任务          | 任务描述                 | 备注       |
| --- | ----------- | -------------------- | -------- |
| 1   | 移植现有驱动及单元测试 | 在feature-kernel分支上修改 | 仅修改设备树文件 |
|     |             |                      |          |

## 4 系统和应用库开发

| 编号  | 任务              | 任务描述        | 备注  |
| --- | --------------- | ----------- | --- |
| 1   | 安装POSIX库        | n/a         |     |
| 2   | 定义POSIX 消息结构    | 包含消息长度和消息数组 |     |
| 3   | 测试POSIX消息库      | n/a         |     |
| 4   | 安装MQTT客户端和服务器端库 | n/a         |     |
| 5   | 定义MQTT 消息结构     | n/a         |     |
| 6   | 测试MQTT消息库       | n/a         |     |
|     |                 |             |     |

## 5 中间层开发

| 编号  | 任务                 | 任务描述                 | 备注  |
| --- | ------------------ | -------------------- | --- |
| 1   | 新建uart-man及单元测试    | 输入是POSIX消息，输出是MQTT消息 |     |
| 2   | 新建eth-man及单元测试     | 输入是POSIX消息，输出是MQTT消息 |     |
| 3   | 新建cfg进程及单元测试       | n/a                  |     |
| 4   | 新建fetch进程及单元测试     | n/a                  |     |
| 5   | 新建曝光进程及单元测试        | n/a                  |     |
| 6   | 新建delay_msg进程及单元测试 | n/a                  |     |
| 7   | 新建stop_msg进程及单元测试  | n/a                  |     |
| 8   | 新建version进程及单元测试   | n/a                  |     |
| 9   | 新建power进程及单元测试     | n/a                  |     |
| 10  | 新建上电恢复进程及单元测试      | n/a                  |     |
| 11  | 新建time进程及单元测试      | n/a                  |     |


## 6 终端应用开发

| 编号  | 任务                       | 任务描述                       | 备注  |
| --- | ------------------------ | -------------------------- | --- |
| 1   | 移植并修改CPU温度进程及单元测试        | 由system V IPC 转换为MQTT IPC  |     |
| 2   | 移植并修改电源指示进程及单元测试         | 由system V IPC 转换为MQTT IPC  |     |
| 3   | 移植并修改数据库进程及单元测试          | 由system V IPC 转换为MQTT IPC  |     |
| 4   | 移植并修改LED温度进程及单元测试        | 由system V IPC 转换为MQTT IPC  |     |
| 5   | 移植并修改LCD温度进程及单元测试        | 由system V IPC 转换为MQTT IPC  |     |
| 6   | 移植并修改delay_key进程及单元测试    | 由system V IPC 转换为MQTT IPC  |     |
| 7   | 移植并修改stop_key温度进程及单元测试   | 由system V IPC 转换为MQTT IPC  |     |
| 8   | 移植并修改beep温度进程及单元测试       | 由system V IPC 转换为MQTT IPC  |     |
| 9   | 新建激光测距仪进程及单元测试           | 由system V IPC 转换为MQTT IPC  |     |
| 10  | 移植并修改RS232进程的消息队列类型及单元测试 | 由system V IPC 转换为POSIX IPC |     |
| 11  | 移植并修改eth进程的消息队列类型及单元测试   | 由system V IPC 转换为POSIX IPC |     |

## 7 测试GUI开发

| 编号  | 任务                | 任务描述         | 备注  |
| --- | ----------------- | ------------ | --- |
| 1   | 设计C#的单元测试GUI及系统测试 | 进行系统测试和稳定性测试 |     |
|     |                   |              |     |

## 8 文档

| 编号  | 任务            | 任务描述            | 备注  |     |
| --- | ------------- | --------------- | --- | --- |
| 1   | MQTT主题规范文档    | 编写MQTT主题和消息格式规范 |     |     |
| 2   | 命令手册          | 命名通过串口和eth使用的命令 |     |     |
| 3   | bugfix记录文档    | 方便回溯解决的bug      |     |     |
| 3   | 测试中发现bugfix文档 | 记录跟踪在测试中发现bug   |     |     |

