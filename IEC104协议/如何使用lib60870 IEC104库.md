---
time: 2025-06-29
---

### ï¿½ï¿½ï¸ 1. ç¼–è¯‘å’Œå®‰è£…

#### **ç¼–è¯‘åº“**
```bash
# è¿›å…¥åº“ç›®å½•
cd lib60870-C

# ç¼–è¯‘é™æ€åº“
make

# ç¼–è¯‘åŠ¨æ€åº“
make dynlib

# å®‰è£…åˆ°æŒ‡å®šç›®å½•
make install INSTALL_PREFIX=/usr/local
```

#### **ç¼–è¯‘ç¤ºä¾‹**
```bash
# ç¼–è¯‘æ‰€æœ‰ç¤ºä¾‹
make examples

# æˆ–å•ç‹¬ç¼–è¯‘æŸä¸ªç¤ºä¾‹
cd examples/cs104_client
make
```

### ğŸ“š 2. å¤´æ–‡ä»¶åŒ…å«

åœ¨æ‚¨çš„é¡¹ç›®ä¸­ï¼Œéœ€è¦åŒ…å«ä»¥ä¸‹å¤´æ–‡ä»¶ï¼š

```c
// åŸºæœ¬IEC104åŠŸèƒ½
#include "cs104_connection.h"      // CS104å®¢æˆ·ç«¯è¿æ¥
#include "cs104_slave.h"           // CS104æœåŠ¡å™¨
#include "cs101_information_objects.h"  // ä¿¡æ¯å¯¹è±¡å®šä¹‰
#include "iec60870_common.h"       // é€šç”¨å®šä¹‰

// ç¡¬ä»¶æŠ½è±¡å±‚
#include "hal_time.h"              // æ—¶é—´å‡½æ•°
#include "hal_thread.h"            // çº¿ç¨‹å‡½æ•°
```

### ï¿½ï¿½ 3. å®¢æˆ·ç«¯ï¼ˆä¸»ç«™ï¼‰ä½¿ç”¨

#### **åŸºæœ¬å®¢æˆ·ç«¯ç¨‹åº**
```c
#include "cs104_connection.h"
#include "hal_time.h"
#include "hal_thread.h"
#include <stdio.h>

// è¿æ¥äº‹ä»¶å¤„ç†
static void connectionHandler(void* parameter, CS104_Connection connection, CS104_ConnectionEvent event) {
    switch (event) {
    case CS104_CONNECTION_OPENED:
        printf("è¿æ¥å·²å»ºç«‹\n");
        break;
    case CS104_CONNECTION_CLOSED:
        printf("è¿æ¥å·²å…³é—­\n");
        break;
    case CS104_CONNECTION_FAILED:
        printf("è¿æ¥å¤±è´¥\n");
        break;
    }
}

// ASDUæ¥æ”¶å¤„ç†
static bool asduReceivedHandler(void* parameter, int address, CS101_ASDU asdu) {
    printf("æ”¶åˆ°ASDU: ç±»å‹=%s, å…ƒç´ æ•°=%d\n", 
           TypeID_toString(CS101_ASDU_getTypeID(asdu)),
           CS101_ASDU_getNumberOfElements(asdu));
    
    // å¤„ç†ä¸åŒç±»å‹çš„ASDU
    switch (CS101_ASDU_getTypeID(asdu)) {
    case M_SP_NA_1:  // å•ç‚¹ä¿¡æ¯
        printf("å•ç‚¹ä¿¡æ¯\n");
        break;
    case M_ME_NB_1:  // æµ‹é‡å€¼
        printf("æµ‹é‡å€¼\n");
        break;
    }
    
    return true;
}

int main() {
    // åˆ›å»ºè¿æ¥
    CS104_Connection con = CS104_Connection_create("192.168.1.100", 2404);
    
    // è®¾ç½®å›è°ƒå‡½æ•°
    CS104_Connection_setConnectionHandler(con, connectionHandler, NULL);
    CS104_Connection_setASDUReceivedHandler(con, asduReceivedHandler, NULL);
    
    // è®¾ç½®åº”ç”¨å±‚å‚æ•°
    CS101_AppLayerParameters alParams = CS104_Connection_getAppLayerParameters(con);
    alParams->originatorAddress = 1;
    
    // è¿æ¥æœåŠ¡å™¨
    if (CS104_Connection_connect(con)) {
        printf("è¿æ¥æˆåŠŸ\n");
        
        // å‘é€å¯åŠ¨æ•°æ®ä¼ è¾“
        CS104_Connection_sendStartDT(con);
        
        // å‘é€æ€»å¬å”¤å‘½ä»¤
        CS104_Connection_sendInterrogationCommand(con, CS101_COT_ACTIVATION, 1, IEC60870_QOI_STATION);
        
        // ç­‰å¾…å“åº”
        Thread_sleep(5000);
        
        // å‘é€åœæ­¢æ•°æ®ä¼ è¾“
        CS104_Connection_sendStopDT(con);
    }
    
    // æ¸…ç†èµ„æº
    CS104_Connection_destroy(con);
    return 0;
}
```

#### **å‘é€æ§åˆ¶å‘½ä»¤**
```c
// å‘é€å•ç‚¹æ§åˆ¶å‘½ä»¤
InformationObject sc = (InformationObject) SingleCommand_create(NULL, 5000, true, false, 0);
CS104_Connection_sendProcessCommandEx(con, CS101_COT_ACTIVATION, 1, sc);
InformationObject_destroy(sc);

// å‘é€æ—¶é’ŸåŒæ­¥å‘½ä»¤
struct sCP56Time2a newTime;
CP56Time2a_createFromMsTimestamp(&newTime, Hal_getTimeInMs());
CS104_Connection_sendClockSyncCommand(con, 1, &newTime);
```

### ğŸ–¥ï¸ 4. æœåŠ¡å™¨ï¼ˆä»ç«™ï¼‰ä½¿ç”¨

#### **åŸºæœ¬æœåŠ¡å™¨ç¨‹åº**
```c
#include "cs104_slave.h"
#include "hal_thread.h"
#include <stdio.h>

static bool running = true;

// æ€»å¬å”¤å¤„ç†
static bool interrogationHandler(void* parameter, IMasterConnection connection, CS101_ASDU asdu, uint8_t qoi) {
    printf("æ”¶åˆ°æ€»å¬å”¤å‘½ä»¤ï¼Œç»„å·: %d\n", qoi);
    
    if (qoi == 20) { // ç«™å¬å”¤
        CS101_AppLayerParameters alParams = IMasterConnection_getApplicationLayerParameters(connection);
        
        // å‘é€ç¡®è®¤
        IMasterConnection_sendACT_CON(connection, asdu, false);
        
        // å‘é€æµ‹é‡å€¼
        CS101_ASDU newAsdu = CS101_ASDU_create(alParams, false, CS101_COT_INTERROGATED_BY_STATION, 0, 1, false, false);
        
        InformationObject io = (InformationObject) MeasuredValueScaled_create(NULL, 100, 1234, IEC60870_QUALITY_GOOD);
        CS101_ASDU_addInformationObject(newAsdu, io);
        InformationObject_destroy(io);
        
        IMasterConnection_sendASDU(connection, newAsdu);
        CS101_ASDU_destroy(newAsdu);
        
        // å‘é€æ€»å¬å”¤ç»ˆæ­¢
        IMasterConnection_sendACT_TERM(connection, asdu);
    }
    
    return true;
}

// æ§åˆ¶å‘½ä»¤å¤„ç†
static bool asduHandler(void* parameter, IMasterConnection connection, CS101_ASDU asdu) {
    if (CS101_ASDU_getTypeID(asdu) == C_SC_NA_1) {
        printf("æ”¶åˆ°å•ç‚¹æ§åˆ¶å‘½ä»¤\n");
        
        if (CS101_ASDU_getCOT(asdu) == CS101_COT_ACTIVATION) {
            InformationObject io = CS101_ASDU_getElement(asdu, 0);
            
            if (io) {
                SingleCommand sc = (SingleCommand) io;
                printf("IOA: %d, çŠ¶æ€: %d\n", 
                       InformationObject_getObjectAddress(io),
                       SingleCommand_getState(sc));
                
                // å‘é€ç¡®è®¤
                CS101_ASDU_setCOT(asdu, CS101_COT_ACTIVATION_CON);
                IMasterConnection_sendASDU(connection, asdu);
                
                InformationObject_destroy(io);
            }
        }
        return true;
    }
    return false;
}

int main() {
    // åˆ›å»ºä»ç«™
    CS104_Slave slave = CS104_Slave_create(100, "");
    
    // è®¾ç½®å›è°ƒå‡½æ•°
    CS104_Slave_setInterrogationHandler(slave, interrogationHandler, NULL);
    CS104_Slave_setASDUHandler(slave, asduHandler, NULL);
    
    // å¯åŠ¨ä»ç«™
    CS104_Slave_start(slave, false);
    
    printf("IEC104ä»ç«™å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£2404\n");
    
    // ä¿æŒè¿è¡Œ
    while (running) {
        Thread_sleep(1000);
    }
    
    CS104_Slave_destroy(slave);
    return 0;
}
```

### ï¿½ï¿½ 5. ç¼–è¯‘æ‚¨çš„é¡¹ç›®

#### **ä½¿ç”¨Makefile**
```makefile
LIB60870_HOME=/path/to/lib60870-C

PROJECT_BINARY_NAME = my_iec104_client
PROJECT_SOURCES = my_client.c

include $(LIB60870_HOME)/make/target_system.mk
include $(LIB60870_HOME)/make/stack_includes.mk

all: $(PROJECT_BINARY_NAME)

$(PROJECT_BINARY_NAME): $(PROJECT_SOURCES) $(LIB_NAME)
	$(CC) $(CFLAGS) $(LDFLAGS) -o $(PROJECT_BINARY_NAME) $(PROJECT_SOURCES) $(INCLUDES) $(LIB_NAME) $(LDLIBS)

include $(LIB60870_HOME)/make/common_targets.mk
```

#### **ä½¿ç”¨CMake**
```cmake
cmake_minimum_required(VERSION 3.10)
project(my_iec104_project)

# æ·»åŠ lib60870åº“
add_subdirectory(lib60870-C)

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(my_client my_client.c)

# é“¾æ¥åº“
target_link_libraries(my_client lib60870)
```

#### **ä½¿ç”¨gccç›´æ¥ç¼–è¯‘**
```bash
gcc -I./lib60870-C/src/inc/api -I./lib60870-C/src/hal/inc \
    -L./lib60870-C -llib60870 \
    my_client.c -o my_client -lpthread
```

### ğŸ”’ 6. TLSå®‰å…¨é€šä¿¡

#### **å¯ç”¨TLSæ”¯æŒ**
```bash
# ä¸‹è½½mbedtls
cd lib60870-C/dependencies
wget https://github.com/ARMmbed/mbedtls/archive/refs/tags/v2.28.0.tar.gz
tar -xzf v2.28.0.tar.gz

# ç¼–è¯‘å¸¦TLSçš„åº“
cd ..
make WITH_MBEDTLS=1
```

#### **TLSå®¢æˆ·ç«¯ç¤ºä¾‹**
```c
// åˆ›å»ºTLSè¿æ¥
CS104_Connection con = CS104_Connection_create("192.168.1.100", 2404);

// è®¾ç½®TLSå‚æ•°
CS104_Connection_setTlsMode(con, CS104_TLS_MODE_REQUIRED);
CS104_Connection_setTlsVersion(con, CS104_TLS_VERSION_1_2);

// è®¾ç½®è¯ä¹¦
CS104_Connection_setCaFile(con, "ca.crt");
CS104_Connection_setCertFile(con, "client.crt");
CS104_Connection_setKeyFile(con, "client.key");

CS104_Connection_connect(con);
```

### ï¿½ï¿½ 7. å¸¸ç”¨åŠŸèƒ½ç¤ºä¾‹

#### **å‘é€æµ‹é‡å€¼**
```c
// åˆ›å»ºæµ‹é‡å€¼ASDU
CS101_ASDU asdu = CS101_ASDU_create(alParams, false, CS101_COT_SPONTANEOUS, 0, 1, false, false);

// æ·»åŠ æµ‹é‡å€¼
InformationObject io = (InformationObject) MeasuredValueScaled_create(NULL, 100, 1234, IEC60870_QUALITY_GOOD);
CS101_ASDU_addInformationObject(asdu, io);
InformationObject_destroy(io);

// å‘é€ASDU
CS104_Connection_sendASDU(con, asdu);
CS101_ASDU_destroy(asdu);
```

#### **å‘é€çŠ¶æ€ä¿¡æ¯**
```c
// åˆ›å»ºå•ç‚¹ä¿¡æ¯ASDU
CS101_ASDU asdu = CS101_ASDU_create(alParams, false, CS101_COT_SPONTANEOUS, 0, 1, false, false);

// æ·»åŠ å•ç‚¹ä¿¡æ¯
InformationObject io = (InformationObject) SinglePointInformation_create(NULL, 200, true, IEC60870_QUALITY_GOOD);
CS101_ASDU_addInformationObject(asdu, io);
InformationObject_destroy(io);

// å‘é€ASDU
CS104_Connection_sendASDU(con, asdu);
CS101_ASDU_destroy(asdu);
```

### ğŸ› 8. è°ƒè¯•å’Œæ•…éšœæ’é™¤

#### **å¯ç”¨æ¶ˆæ¯æ—¥å¿—**
```c
// è®¾ç½®åŸå§‹æ¶ˆæ¯å¤„ç†å‡½æ•°
static void rawMessageHandler(void* parameter, uint8_t* msg, int msgSize, bool sent) {
    if (sent)
        printf("å‘é€: ");
    else
        printf("æ¥æ”¶: ");
    
    for (int i = 0; i < msgSize; i++) {
        printf("%02x ", msg[i]);
    }
    printf("\n");
}

CS104_Connection_setRawMessageHandler(con, rawMessageHandler, NULL);
```

#### **å¸¸è§é—®é¢˜**
1. **è¿æ¥å¤±è´¥**ï¼šæ£€æŸ¥IPåœ°å€å’Œç«¯å£
2. **ç¼–è¯‘é”™è¯¯**ï¼šç¡®ä¿åŒ…å«æ­£ç¡®çš„å¤´æ–‡ä»¶è·¯å¾„
3. **é“¾æ¥é”™è¯¯**ï¼šç¡®ä¿é“¾æ¥äº†lib60870åº“
4. **TLSé”™è¯¯**ï¼šæ£€æŸ¥è¯ä¹¦æ–‡ä»¶è·¯å¾„å’Œæ ¼å¼

### ï¿½ï¿½ 9. æœ€ä½³å®è·µ

1. **é”™è¯¯å¤„ç†**ï¼šå§‹ç»ˆæ£€æŸ¥å‡½æ•°è¿”å›å€¼
2. **èµ„æºç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾åˆ›å»ºçš„å¯¹è±¡
3. **çº¿ç¨‹å®‰å…¨**ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨é€‚å½“çš„åŒæ­¥æœºåˆ¶
4. **é…ç½®ç®¡ç†**ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ç®¡ç†è¿æ¥å‚æ•°
5. **æ—¥å¿—è®°å½•**ï¼šå®ç°é€‚å½“çš„æ—¥å¿—è®°å½•æœºåˆ¶

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæ‚¨å°±å¯ä»¥å¼€å§‹ä½¿ç”¨lib60870åº“å¼€å‘IEC104åº”ç”¨ç¨‹åºäº†ã€‚å»ºè®®ä»ç®€å•çš„ç¤ºä¾‹å¼€å§‹ï¼Œé€æ­¥æ·»åŠ æ›´å¤æ‚çš„åŠŸèƒ½ã€‚