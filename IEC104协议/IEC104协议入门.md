---
time: 2025-06-29
---
æˆ‘æ¥å¸®æ‚¨äº†è§£å¦‚ä½•ä½¿ç”¨IEC104åè®®å…¥é—¨ã€‚è®©æˆ‘å…ˆæŸ¥çœ‹ä¸€ä¸‹ç›¸å…³çš„ç¤ºä¾‹ä»£ç å’Œæ–‡æ¡£ã€‚

Ran tool
Ran tool
Read file: lib60870-C/examples/cs104_client/simple_client.c
Read file: lib60870-C/examples/cs104_server/simple_server.c
Read file: user_guide.adoc
åŸºäºæˆ‘å¯¹lib60870é¡¹ç›®çš„åˆ†æï¼Œæˆ‘æ¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨IEC104åè®®å…¥é—¨ï¼š

## IEC104åè®®å…¥é—¨æŒ‡å—

### ï¿½ï¿½ ä»€ä¹ˆæ˜¯IEC104ï¼Ÿ

IEC104ï¼ˆIEC 60870-5-104ï¼‰æ˜¯å›½é™…ç”µå·¥å§”å‘˜ä¼šåˆ¶å®šçš„ç”µåŠ›ç³»ç»Ÿé€šä¿¡åè®®ï¼Œç”¨äºä¸»ç«™å’Œå­ç«™ä¹‹é—´çš„TCP/IPé€šä¿¡ã€‚å®ƒæ˜¯IEC 60870-5-101åè®®çš„TCP/IPç‰ˆæœ¬ã€‚

### ğŸ“š å­¦ä¹ è·¯å¾„

#### 1. **ç†è®ºåŸºç¡€**
- äº†è§£IEC104åè®®çš„åŸºæœ¬æ¦‚å¿µ
- æŒæ¡ASDUï¼ˆåº”ç”¨æœåŠ¡æ•°æ®å•å…ƒï¼‰ç»“æ„
- ç†è§£ä¸»ç«™/ä»ç«™é€šä¿¡æ¨¡å¼
- å­¦ä¹ ä¼ è¾“åŸå› ï¼ˆCOTï¼‰å’Œæ•°æ®ç±»å‹

#### 2. **ç¯å¢ƒå‡†å¤‡**
```bash
# ç¼–è¯‘åº“
cd lib60870-C
make

# ç¼–è¯‘ç¤ºä¾‹
cd examples
make
```

#### 3. **ä»ç®€å•ç¤ºä¾‹å¼€å§‹**

### ï¿½ï¿½ å¿«é€Ÿå…¥é—¨ç¤ºä¾‹

#### **å®¢æˆ·ç«¯ï¼ˆä¸»ç«™ï¼‰ç¤ºä¾‹**
```c
#include "cs104_connection.h"
#include "hal_time.h"
#include "hal_thread.h"

// è¿æ¥äº‹ä»¶å¤„ç†
static void connectionHandler(void* parameter, CS104_Connection connection, CS104_ConnectionEvent event) {
    switch (event) {
    case CS104_CONNECTION_OPENED:
        printf("è¿æ¥å·²å»ºç«‹\n");
        break;
    case CS104_CONNECTION_CLOSED:
        printf("è¿æ¥å·²å…³é—­\n");
        break;
    }
}

// ASDUæ¥æ”¶å¤„ç†
static bool asduReceivedHandler(void* parameter, int address, CS101_ASDU asdu) {
    printf("æ”¶åˆ°ASDUç±»å‹: %s\n", TypeID_toString(CS101_ASDU_getTypeID(asdu)));
    return true;
}

int main() {
    // åˆ›å»ºè¿æ¥
    CS104_Connection con = CS104_Connection_create("127.0.0.1", 2404);
    
    // è®¾ç½®å›è°ƒå‡½æ•°
    CS104_Connection_setConnectionHandler(con, connectionHandler, NULL);
    CS104_Connection_setASDUReceivedHandler(con, asduReceivedHandler, NULL);
    
    // è¿æ¥æœåŠ¡å™¨
    if (CS104_Connection_connect(con)) {
        printf("è¿æ¥æˆåŠŸï¼\n");
        
        // å‘é€å¯åŠ¨æ•°æ®ä¼ è¾“
        CS104_Connection_sendStartDT(con);
        
        // å‘é€æ€»å¬å”¤å‘½ä»¤
        CS104_Connection_sendInterrogationCommand(con, CS101_COT_ACTIVATION, 1, IEC60870_QOI_STATION);
        
        Thread_sleep(5000);
    }
    
    CS104_Connection_destroy(con);
    return 0;
}
```

#### **æœåŠ¡å™¨ï¼ˆä»ç«™ï¼‰ç¤ºä¾‹**
```c
#include "cs104_slave.h"
#include "hal_thread.h"

static bool interrogationHandler(void* parameter, IMasterConnection connection, CS101_ASDU asdu, uint8_t qoi) {
    printf("æ”¶åˆ°æ€»å¬å”¤å‘½ä»¤ï¼Œç»„å·: %i\n", qoi);
    
    if (qoi == 20) { // ç«™å¬å”¤
        CS101_AppLayerParameters alParams = IMasterConnection_getApplicationLayerParameters(connection);
        
        // å‘é€ç¡®è®¤
        IMasterConnection_sendACT_CON(connection, asdu, false);
        
        // åˆ›å»ºæµ‹é‡å€¼ASDU
        CS101_ASDU newAsdu = CS101_ASDU_create(alParams, false, CS101_COT_INTERROGATED_BY_STATION, 0, 1, false, false);
        
        // æ·»åŠ æµ‹é‡å€¼ä¿¡æ¯å¯¹è±¡
        InformationObject io = (InformationObject) MeasuredValueScaled_create(NULL, 100, 1234, IEC60870_QUALITY_GOOD);
        CS101_ASDU_addInformationObject(newAsdu, io);
        InformationObject_destroy(io);
        
        // å‘é€ASDU
        IMasterConnection_sendASDU(connection, newAsdu);
        CS101_ASDU_destroy(newAsdu);
        
        // å‘é€æ€»å¬å”¤ç»ˆæ­¢
        IMasterConnection_sendACT_TERM(connection, asdu);
    }
    
    return true;
}

int main() {
    // åˆ›å»ºä»ç«™
    CS104_Slave slave = CS104_Slave_create(100, "");
    
    // è®¾ç½®å›è°ƒå‡½æ•°
    CS104_Slave_setInterrogationHandler(slave, interrogationHandler, NULL);
    
    // å¯åŠ¨ä»ç«™
    CS104_Slave_start(slave, false);
    
    printf("IEC104ä»ç«™å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£2404\n");
    
    // ä¿æŒè¿è¡Œ
    while (running) {
        Thread_sleep(1000);
    }
    
    CS104_Slave_destroy(slave);
    return 0;
}
```

### ğŸš€ å®è·µæ­¥éª¤

#### **ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘å’Œè¿è¡Œç¤ºä¾‹**
```bash
# ç¼–è¯‘å®¢æˆ·ç«¯ç¤ºä¾‹
cd lib60870-C/examples/cs104_client
make
./simple_client

# ç¼–è¯‘æœåŠ¡å™¨ç¤ºä¾‹  
cd ../cs104_server
make
./simple_server
```

#### **ç¬¬äºŒæ­¥ï¼šç†è§£æ ¸å¿ƒæ¦‚å¿µ**

1. **ASDUç»“æ„**ï¼š
   - TypeIDï¼šæ•°æ®ç±»å‹ï¼ˆå¦‚M_SP_NA_1å•ç‚¹ä¿¡æ¯ï¼‰
   - COTï¼šä¼ è¾“åŸå› ï¼ˆå¦‚COT_ACTIVATIONæ¿€æ´»ï¼‰
   - OAï¼šæºåœ°å€
   - CAï¼šå…¬å…±åœ°å€
   - ä¿¡æ¯å¯¹è±¡ï¼šå…·ä½“çš„æ•°æ®å†…å®¹

2. **é€šä¿¡æµç¨‹**ï¼š
   - å»ºç«‹TCPè¿æ¥
   - å‘é€STARTDTå¯åŠ¨æ•°æ®ä¼ è¾“
   - å‘é€å‘½ä»¤/æ¥æ”¶æ•°æ®
   - å‘é€STOPDTåœæ­¢æ•°æ®ä¼ è¾“

#### **ç¬¬ä¸‰æ­¥ï¼šå¸¸ç”¨åŠŸèƒ½å®ç°**

1. **æ€»å¬å”¤**ï¼šè·å–æ‰€æœ‰æ•°æ®ç‚¹çŠ¶æ€
2. **æ—¶é’ŸåŒæ­¥**ï¼šåŒæ­¥ç³»ç»Ÿæ—¶é—´
3. **æ§åˆ¶å‘½ä»¤**ï¼šå‘é€å¼€å…³æ§åˆ¶å‘½ä»¤
4. **æµ‹é‡å€¼ä¼ è¾“**ï¼šä¼ è¾“æ¨¡æ‹Ÿé‡æ•°æ®
5. **çŠ¶æ€ä¿¡æ¯**ï¼šä¼ è¾“å¼€å…³çŠ¶æ€

### ğŸ“– å­¦ä¹ èµ„æº

1. **é¡¹ç›®æ–‡æ¡£**ï¼š
   - `user_guide.adoc`ï¼šè¯¦ç»†ç”¨æˆ·æŒ‡å—
   - `examples/`ï¼šä¸°å¯Œçš„ç¤ºä¾‹ä»£ç 
   - APIæ–‡æ¡£ï¼šhttps://support.mz-automation.de/doc/lib60870/latest/

2. **ç¤ºä¾‹ä»£ç **ï¼š
   - `cs104_client/`ï¼šå®¢æˆ·ç«¯ç¤ºä¾‹
   - `cs104_server/`ï¼šæœåŠ¡å™¨ç¤ºä¾‹
   - `cs104_client_async/`ï¼šå¼‚æ­¥å®¢æˆ·ç«¯
   - `tls_client/`ã€`tls_server/`ï¼šTLSå®‰å…¨é€šä¿¡

### ï¿½ï¿½ è¿›é˜¶å»ºè®®

1. **ä»ç®€å•ç¤ºä¾‹å¼€å§‹**ï¼Œé€æ­¥ç†è§£åè®®ç»†èŠ‚
2. **ä½¿ç”¨è°ƒè¯•åŠŸèƒ½**ï¼Œè§‚å¯Ÿæ¶ˆæ¯äº¤æ¢è¿‡ç¨‹
3. **å‚è€ƒç”¨æˆ·æŒ‡å—**ï¼Œæ·±å…¥äº†è§£APIç”¨æ³•
4. **å®è·µä¸åŒæ•°æ®ç±»å‹**ï¼ŒæŒæ¡å„ç§ASDUç±»å‹
5. **è€ƒè™‘å®‰å…¨éœ€æ±‚**ï¼Œå­¦ä¹ TLSåŠ å¯†é€šä¿¡

é€šè¿‡è¿™ä¸ªå¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯å¾„ï¼Œæ‚¨å¯ä»¥å¿«é€ŸæŒæ¡IEC104åè®®çš„ä½¿ç”¨ï¼Œå¹¶èƒ½å¤Ÿå¼€å‘è‡ªå·±çš„IEC104åº”ç”¨ç¨‹åºã€‚